<!DOCTYPE html>
<html class="light" lang="en"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Clean Slate Dashboard - Contacts</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
<script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#136dec",
                        "background": "#fcfcfc",
                        "sidebar": "#f8f9fa",
                        "border-color": "#eeeeee"
                    },
                    fontFamily: {
                        "sans": ["Inter", "sans-serif"]
                    }
                },
            },
        }
    </script>
<style type="text/tailwindcss">
        body {
            @apply bg-background text-gray-800;
        }
        .sidebar-item {
            @apply flex items-center gap-3 px-4 py-2 text-sm font-medium text-gray-600 rounded-md transition-colors hover:bg-gray-200/50;
        }
        .sidebar-item.active {
            @apply text-primary bg-primary/5;
        }
        .table-row {
            @apply border-b border-border-color hover:bg-gray-50/50 transition-colors;
        }
    </style>
</head>
<body class="antialiased">
<header class="w-full bg-white/90 dark:bg-gray-900/70 backdrop-blur-sm shadow-sm px-4 py-3 flex items-center gap-4">
  <a href="/" class="text-sm font-semibold text-primary">&larr; Back</a>
  <div class="text-sm text-gray-600">Contact List (Dashboard 1)</div>
  <nav class="ml-auto flex gap-2">
    <a href="/dashboard1" class="px-3 py-1 bg-blue-600 text-white rounded text-sm">D1</a>
    <a href="/add-contact" class="px-3 py-1 bg-green-600 text-white rounded text-sm">Add</a>
    <a href="/dashboard2" class="px-3 py-1 bg-purple-600 text-white rounded text-sm">Groups</a>
    <a href="/dashboard3" class="px-3 py-1 bg-orange-600 text-white rounded text-sm">New Group</a>
  </nav>
</header>
<div class="flex h-screen overflow-hidden">
<aside class="w-64 bg-sidebar border-r border-border-color flex flex-col shrink-0">
<div class="p-8">
<h1 class="text-sm font-bold tracking-widest text-gray-400 uppercase">Contacts</h1>
</div>
<nav class="flex-1 px-4 space-y-1">
<a class="sidebar-item active" href="#">
<span class="material-symbols-outlined text-xl">person</span>
<span>All Contacts</span>
</a>
<div class="pt-2">
<a class="sidebar-item w-full text-left text-gray-400 hover:text-primary group" href="/dashboard2">
    <span class="material-symbols-outlined text-xl">add</span>
    <span>Group</span>
</a>
</div>
</nav>
<div class="p-6 mt-auto">
<div class="flex items-center gap-3 px-2">
<img alt="Profile" class="size-8 rounded-full object-cover" src="https://lh3.googleusercontent.com/aida-public/AB6AXuAQScCWfGGuTg6A24flA8R8DM2cr6f7RjfmjuZebajyweprT5NmKoU0RtkuKK3SPHHCZCX5UKL9ujrqHIeoWcI-NyLyLGbjGaeQacV5GfFst4WZTUaiHXt8y0DHfBArarh3_OkhD-s9Nfnh3LiUKHMfn-jp5ca1GXp3tPnuq1gUUJ6jf0wDNua-RV1DHgrhgwqN0tpxe9FX9ciRG63yEnoy62e2YfBLbrsEhGSGkMbHgEhFlDD_HQqVVXnDo3_UfgKMNzzyJzV4lzo"/>
<div class="overflow-hidden">
<p class="text-xs font-semibold truncate text-gray-700">Alex Morgan</p>
</div>
</div>
</div>
</aside>
<main class="flex-1 flex flex-col bg-white overflow-hidden">
<header class="px-10 py-6 border-b border-border-color">
<div class="max-w-5xl mx-auto flex items-center justify-between gap-4">
<div class="flex-1 relative">
<span class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-gray-400">search</span>
<input id="searchInput"
        class="w-full bg-gray-50 border border-gray-200 rounded-lg pl-12 pr-4 py-3 text-sm focus:ring-1 focus:ring-primary focus:border-primary outline-none transition-all"
        placeholder="Search for contacts..."
        type="text"/>
</div>
<div class="flex items-center gap-3 shrink-0">
<button id="deleteAllBtn" class="border border-red-200 hover:bg-red-50 text-red-600 px-5 py-3 rounded-lg text-sm font-semibold flex items-center gap-2 transition-all">
<span class="material-symbols-outlined text-lg">delete_sweep</span>
                        Delete All
                    </button>
<a href="/add-contact">
    <button class="bg-primary hover:bg-blue-600 text-white px-6 py-3 rounded-lg text-sm font-semibold flex items-center gap-2 transition-all">
        <span class="material-symbols-outlined text-lg">add</span>
        Add Contact
    </button>
</a>
</div>
</div>
</header>
<div class="flex-1 overflow-y-auto px-10 py-8">
<div class="max-w-5xl mx-auto">
<div class="flex justify-end mb-6">
  <div class="flex items-center gap-3">
    <label for="sortBy" class="sr-only">Sort by</label>
    <div class="flex items-center gap-2 bg-white border border-gray-200 rounded-lg px-3 py-1 shadow-sm">
      <span class="text-xs font-medium text-gray-500 uppercase tracking-wider">Sort</span>
      <select id="sortBy" class="text-xs border-none outline-none bg-transparent">
        <option value="name">Name</option>
        <option value="phone">Phone</option>
        <option value="group">Group</option>
      </select>
      <select id="sortDir" class="text-xs border-none outline-none bg-transparent">
        <option value="asc">A → Z</option>
        <option value="desc">Z → A</option>
      </select>
    </div>
  </div>
</div>
<div class="w-full">
<table class="w-full text-left">
<thead>
<tr class="border-b border-border-color">
<th class="pb-4 text-[11px] font-bold text-gray-400 uppercase tracking-widest w-1/3">Name</th>
<th class="pb-4 text-[11px] font-bold text-gray-400 uppercase tracking-widest w-1/3">Phone</th>
<th class="pb-4 text-[11px] font-bold text-gray-400 uppercase tracking-widest w-1/4">Group</th>
<th class="pb-4 text-[11px] font-bold text-gray-400 uppercase tracking-widest text-right">Actions</th>
</tr>
</thead>
<tbody id="contactsBody" class="divide-y divide-border-color">
<tr class="table-row">
<td class="py-12 text-center" colspan="4">
<div class="text-gray-500">Loading contacts…</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</main>
</div>

<!-- Custom Confirmation Modal -->
<div id="confirmModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center">
  <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 transform transition-all">
    <div class="p-6">
      <div class="flex items-center justify-center w-16 h-16 mx-auto mb-4 bg-red-100 rounded-full">
        <span class="material-symbols-outlined text-4xl text-red-600">warning</span>
      </div>
      <h3 class="text-xl font-bold text-gray-900 text-center mb-2" id="modalTitle">Confirm Delete</h3>
      <p class="text-gray-600 text-center mb-6" id="modalMessage">Are you sure you want to delete this contact?</p>
      <div class="flex gap-3">
        <button id="modalCancel" class="flex-1 px-4 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold rounded-lg transition-all">
          Cancel
        </button>
        <button id="modalConfirm" class="flex-1 px-4 py-3 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg transition-all">
          Delete
        </button>
      </div>
    </div>
  </div>
</div>

<script>
const body = document.getElementById('contactsBody');
const input = document.getElementById('searchInput');
const sortByEl = document.getElementById('sortBy');
const sortDirEl = document.getElementById('sortDir');
let contactsCache = [];
let debounceTimer = null;

// Custom modal functions
const modal = document.getElementById('confirmModal');
const modalTitle = document.getElementById('modalTitle');
const modalMessage = document.getElementById('modalMessage');
const modalConfirm = document.getElementById('modalConfirm');
const modalCancel = document.getElementById('modalCancel');

function showConfirmModal(title, message) {
  return new Promise((resolve) => {
    modalTitle.textContent = title;
    modalMessage.textContent = message;
    modal.classList.remove('hidden');
    
    const handleConfirm = () => {
      modal.classList.add('hidden');
      modalConfirm.removeEventListener('click', handleConfirm);
      modalCancel.removeEventListener('click', handleCancel);
      resolve(true);
    };
    
    const handleCancel = () => {
      modal.classList.add('hidden');
      modalConfirm.removeEventListener('click', handleConfirm);
      modalCancel.removeEventListener('click', handleCancel);
      resolve(false);
    };
    
    modalConfirm.addEventListener('click', handleConfirm);
    modalCancel.addEventListener('click', handleCancel);
  });
}

async function loadContactsOnce(){
  body.innerHTML = '<tr class="table-row"><td class="py-12 text-center" colspan="4"><div class="text-gray-500">Loading contacts…</div></td></tr>';
  try{
    const res = await fetch('/api/contacts', { cache: 'no-store' })
    if(!res.ok) throw new Error('Status ' + res.status);
    contactsCache = await res.json();
  }catch(err){
    console.error('[UI] loadContacts error', err);
    body.innerHTML = '<tr class="table-row"><td class="py-12 text-center" colspan="4"><div class="text-red-500">Lỗi tải dữ liệu (không thể đọc contacts.json)</div></td></tr>';
    contactsCache = [];
  }
}

function applySort(list, by='name', dir='asc'){
  const copy = Array.from(list);
  const reverse = (dir === 'desc');
  copy.sort((a,b)=>{
    const va = (a[by] || '').toString().toLowerCase();
    const vb = (b[by] || '').toString().toLowerCase();
    if(va < vb) return reverse ? 1 : -1;
    if(va > vb) return reverse ? -1 : 1;
    return 0;
  });
  return copy;
}

function renderList(list){
  if(!list || list.length === 0){
    body.innerHTML = `
      <tr class="table-row">
        <td class="py-12 text-center" colspan="4">
          <div class="text-gray-500">Không tìm thấy liên hệ</div>
        </td>
      </tr>`;
    return;
  }

  body.innerHTML = '';

  list.forEach(contact=>{
    const initials = ((contact.name||'').match(/\b\w/g)||[])
                      .slice(0,2).join('').toUpperCase();

    const tr = document.createElement('tr');
    tr.className = 'table-row';

    tr.innerHTML = `
<td class="py-6">
  <div class="flex items-center gap-4">
    <div class="size-9 rounded-full bg-gray-100 text-gray-500
                flex items-center justify-center font-semibold text-xs">
      ${initials}
    </div>
    <span class="text-sm font-medium text-gray-900">
      ${contact.name}
    </span>
  </div>
</td>

<td class="py-6 text-sm text-gray-500">
  ${contact.phone}
</td>

<td class="py-6">
  <span class="text-[11px] font-bold text-gray-400 uppercase tracking-wider">
    ${contact.group || ''}
  </span>
</td>

<td class="py-6 text-right">
  <button class="delete-btn"
          data-id="${contact.id}"
          title="Xóa liên hệ">
    <span class="material-symbols-outlined
                 text-xl text-gray-300 hover:text-red-500 transition">
      delete
    </span>
  </button>
</td>
`;
    body.appendChild(tr);
  });
}


function filterAndRender(keyword=''){
  const kw = (keyword || '').toString().trim().toLowerCase();
  let list = contactsCache;
  if(kw){
    list = list.filter(c=> (c.name||'').toString().toLowerCase().includes(kw));
  }
  const by = sortByEl ? sortByEl.value : 'name';
  const dir = sortDirEl ? sortDirEl.value : 'asc';
  list = applySort(list, by, dir);
  renderList(list);
}

// initial load
(async function(){
  await loadContactsOnce();
  filterAndRender();
})();

// search with debounce
input.addEventListener('input', function(){
  clearTimeout(debounceTimer);
  const v = this.value.trim();
  debounceTimer = setTimeout(()=> filterAndRender(v), 200);
});

// sort controls
if(sortByEl) sortByEl.addEventListener('change', ()=> filterAndRender(input.value.trim()));
if(sortDirEl) sortDirEl.addEventListener('change', ()=> filterAndRender(input.value.trim()));

// delete all button
const deleteAllBtn = document.getElementById('deleteAllBtn');
if(deleteAllBtn){
  deleteAllBtn.addEventListener('click', async function(){
    if(contactsCache.length === 0){
      alert('No contacts to delete');
      return;
    }

    const confirmed = await showConfirmModal(
      'Delete All Contacts',
      `Are you sure you want to delete ALL ${contactsCache.length} contacts? This action cannot be undone.`
    );
    if(!confirmed) return;

    try{
      // Xóa từng contact một
      const deletePromises = contactsCache.map(contact => 
        fetch('/api/delete', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: contact.id })
        })
      );

      const results = await Promise.all(deletePromises);
      const allSuccess = results.every(r => r.ok);

      if(allSuccess){
        contactsCache = [];
        filterAndRender(input.value.trim());
        alert('All contacts deleted successfully!');
      } else {
        alert('Error occurred while deleting some contacts');
        // Reload lại để đồng bộ
        await loadContactsOnce();
        filterAndRender(input.value.trim());
      }
    }catch(err){
      console.error(err);
      alert('Lỗi kết nối server');
    }
  });
}

body.addEventListener('click', async function(e){
  const btn = e.target.closest('.delete-btn');
  if(!btn) return;

  const id = btn.dataset.id;
  if(!id) return;

  const confirmed = await showConfirmModal(
    'Delete Contact',
    'Are you sure you want to delete this contact? This action cannot be undone.'
  );
  if(!confirmed) return;

  try{
    const res = await fetch('/api/delete', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id })
    });

    const result = await res.json();

    if(!res.ok || !result.success){
      alert(result.message || 'Delete failed');
      return;
    }

    // cập nhật cache & UI ngay
    contactsCache = contactsCache.filter(
      c => String(c.id) !== String(id)
    );

    filterAndRender(input.value.trim());

  }catch(err){
    console.error(err);
    alert('Server connection error');
  }
});
</script>
</body></html>