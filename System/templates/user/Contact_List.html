<!DOCTYPE html>
<html class="light" lang="en"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Clean Slate Dashboard - Contacts</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
<script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#136dec",
                        "background": "#fcfcfc",
                        "sidebar": "#f8f9fa",
                        "border-color": "#eeeeee"
                    },
                    fontFamily: {
                        "sans": ["Inter", "sans-serif"]
                    }
                },
            },
        }
    </script>
<style type="text/tailwindcss">
        body {
            @apply bg-background text-gray-800;
        }
        .sidebar-item {
            @apply flex items-center gap-3 px-4 py-2 text-sm font-medium text-gray-600 rounded-md transition-colors hover:bg-gray-200/50;
        }
        .sidebar-item.active {
            @apply text-primary bg-primary/5;
        }
        .table-row {
            @apply border-b border-border-color hover:bg-gray-50/50 transition-colors;
        }
        /* Confirm dialog styles */
        .confirm-dialog {
            animation: fadeIn 0.2s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body class="antialiased overflow-hidden">
<!-- Confirm Dialog -->
<div id="confirm-dialog" class="hidden fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-4">
    <div class="confirm-dialog bg-white rounded-xl shadow-2xl max-w-md w-full p-6">
        <div class="flex items-center gap-3 mb-4">
            <div id="confirm-icon-container" class="w-10 h-10 rounded-full bg-red-100 flex items-center justify-center">
                <span id="confirm-icon" class="material-symbols-outlined text-red-600">warning</span>
            </div>
            <h3 id="confirm-title" class="text-lg font-semibold text-gray-900">Confirm</h3>
        </div>
        <p id="confirm-message" class="text-gray-600 mb-6">Are you sure?</p>
        <div class="flex justify-end gap-3">
            <button onclick="hideConfirm(false)" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 font-medium text-gray-700">Cancel</button>
            <button id="confirm-btn" onclick="hideConfirm(true)" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium">Confirm</button>
        </div>
    </div>
</div>

<header class="w-full bg-white/90 dark:bg-gray-900/70 backdrop-blur-sm shadow-sm px-4 py-3 flex items-center gap-4">
  <button onclick="handleLogout()" class="text-sm font-semibold text-primary hover:underline cursor-pointer">&larr; Logout</button>
  <div class="text-sm text-gray-600">Contact List</div>
</header>
<div class="flex" style="height: calc(100vh - 52px);">
<aside class="w-64 bg-sidebar border-r border-border-color flex flex-col shrink-0 overflow-hidden">
<div class="p-6 pb-4">
<h1 class="text-sm font-bold tracking-widest text-gray-400 uppercase">Contacts</h1>
</div>
<!-- User Profile - moved to top -->
<div class="px-4 pb-4 border-b border-border-color">
<div class="flex items-center gap-3 px-2 py-2 bg-primary/5 rounded-lg">
<div class="size-9 rounded-full bg-gradient-to-br from-orange-400 to-orange-500 flex items-center justify-center text-white font-semibold text-sm" id="userAvatar">AM</div>
<div class="overflow-hidden flex-1">
<p class="text-sm font-semibold truncate text-gray-800" id="userName">Alex Morgan</p>
<p class="text-xs text-gray-500">User</p>
</div>
</div>
</div>
<nav class="flex-1 px-4 pt-4 space-y-1">
<a class="sidebar-item active" href="#">
<span class="material-symbols-outlined text-xl">person</span>
<span>All Contacts</span>
</a>
<div class="pt-2">
<a class="sidebar-item w-full text-left text-gray-400 hover:text-primary group" href="/groups">
    <span class="material-symbols-outlined text-xl">add</span>
    <span>Group</span>
</a>
</div>
</nav>
</aside>
<main class="flex-1 flex flex-col bg-white overflow-hidden">
<header class="px-10 py-6 border-b border-border-color">
<div class="max-w-5xl mx-auto flex items-center justify-between gap-4">
<div class="flex-1 relative">
<span class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-gray-400">search</span>
<input id="searchInput"
        class="w-full bg-gray-50 border border-gray-200 rounded-lg pl-12 pr-4 py-3 text-sm focus:ring-1 focus:ring-primary focus:border-primary outline-none transition-all"
        placeholder="Search name/phone or use gr:GroupName..."
        type="text"/>
</div>
<div class="flex items-center gap-3 shrink-0">
<button id="deleteAllBtn" class="border border-red-200 hover:bg-red-50 text-red-600 px-5 py-3 rounded-lg text-sm font-semibold flex items-center gap-2 transition-all">
<span class="material-symbols-outlined text-lg">delete_sweep</span>
                        Delete All
                    </button>
<a href="/add-contact">
    <button class="bg-primary hover:bg-blue-700 text-white px-6 py-3 rounded-lg text-sm font-semibold flex items-center gap-2 transition-colors shadow-sm">
        <span class="material-symbols-outlined text-lg">add</span>
        Add Contact
    </button>
</a>
</div>
</div>
</header>
<div class="flex-1 overflow-hidden px-10 py-8">
<div class="max-w-5xl mx-auto h-full flex flex-col">
<div class="flex justify-end mb-6">
  <div class="flex items-center gap-3">
    <label for="sortBy" class="sr-only">Sort by</label>
    <div class="flex items-center gap-2 bg-white border border-gray-200 rounded-lg px-3 py-1 shadow-sm">
      <span class="text-xs font-medium text-gray-500 uppercase tracking-wider">Sort</span>
      <select id="sortBy" class="text-xs border-none outline-none bg-transparent">
        <option value="name">Name</option>
        <option value="phone">Phone</option>
        <option value="group">Group</option>
      </select>
      <select id="sortDir" class="text-xs border-none outline-none bg-transparent">
        <option value="asc">A → Z</option>
        <option value="desc">Z → A</option>
      </select>
    </div>
  </div>
</div>
<div class="flex-1 overflow-y-auto border border-gray-200 rounded-xl bg-gray-50/30" style="max-height: calc(100vh - 320px);">
<table class="w-full text-left">
<thead class="sticky top-0 bg-white shadow-sm z-10">
<tr class="border-b border-border-color">
<th class="px-6 py-4 text-[11px] font-bold text-gray-400 uppercase tracking-widest w-1/3">Name</th>
<th class="px-6 py-4 text-[11px] font-bold text-gray-400 uppercase tracking-widest w-1/3">Phone</th>
<th class="px-6 py-4 text-[11px] font-bold text-gray-400 uppercase tracking-widest w-1/4">Group</th>
<th class="px-6 py-4 text-[11px] font-bold text-gray-400 uppercase tracking-widest text-right">Actions</th>
</tr>
</thead>
<tbody id="contactsBody" class="divide-y divide-border-color bg-white">
<tr class="table-row">
<td class="py-12 text-center" colspan="4">
<div class="text-gray-500">Loading contacts…</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</main>
</div>

<!-- Custom Confirmation Modal -->
<div id="confirmModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center">
  <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 transform transition-all">
    <div class="p-6">
      <div class="flex items-center justify-center w-16 h-16 mx-auto mb-4 bg-red-100 rounded-full">
        <span class="material-symbols-outlined text-4xl text-red-600">warning</span>
      </div>
      <h3 class="text-xl font-bold text-gray-900 text-center mb-2" id="modalTitle">Confirm Delete</h3>
      <p class="text-gray-600 text-center mb-6" id="modalMessage">Are you sure you want to delete this contact?</p>
      <div class="flex gap-3">
        <button id="modalCancel" class="flex-1 px-4 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold rounded-lg transition-all">
          Cancel
        </button>
        <button id="modalConfirm" class="flex-1 px-4 py-3 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg transition-all">
          Delete
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Toast Notification -->
<div id="toast" class="hidden fixed right-6 bottom-6 bg-green-600 text-white px-6 py-4 rounded-xl shadow-2xl flex items-center gap-3 z-50">
  <span class="material-symbols-outlined">check_circle</span>
  <span id="toastMessage">Success!</span>
</div>

<script>
const body = document.getElementById('contactsBody');
const input = document.getElementById('searchInput');
const sortByEl = document.getElementById('sortBy');
const sortDirEl = document.getElementById('sortDir');
let contactsCache = [];
let debounceTimer = null;
let confirmCallback = null;

// Toast notification
function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toastMessage');
    toastMessage.textContent = message;
    toast.className = `fixed right-6 bottom-6 px-6 py-4 rounded-xl shadow-2xl flex items-center gap-3 z-50 ${type === 'success' ? 'bg-green-600 text-white' : 'bg-red-600 text-white'}`;
    toast.classList.remove('hidden');
    setTimeout(() => toast.classList.add('hidden'), 3000);
}

// Confirm dialog functions
function showConfirm(title, message, isLogout = false) {
    return new Promise((resolve) => {
        document.getElementById('confirm-title').textContent = title;
        document.getElementById('confirm-message').textContent = message;
        const iconContainer = document.getElementById('confirm-icon-container');
        const icon = document.getElementById('confirm-icon');
        const btn = document.getElementById('confirm-btn');
        
        if (isLogout) {
            iconContainer.className = 'w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center';
            icon.className = 'material-symbols-outlined text-blue-600';
            icon.textContent = 'logout';
            btn.className = 'px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium';
            btn.textContent = 'Logout';
        } else {
            iconContainer.className = 'w-10 h-10 rounded-full bg-red-100 flex items-center justify-center';
            icon.className = 'material-symbols-outlined text-red-600';
            icon.textContent = 'warning';
            btn.className = 'px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium';
            btn.textContent = 'Delete';
        }
        
        document.getElementById('confirm-dialog').classList.remove('hidden');
        confirmCallback = resolve;
    });
}

function hideConfirm(result) {
    document.getElementById('confirm-dialog').classList.add('hidden');
    if (confirmCallback) confirmCallback(result);
}

// Custom modal functions (legacy)
const modal = document.getElementById('confirmModal');
const modalTitle = document.getElementById('modalTitle');
const modalMessage = document.getElementById('modalMessage');
const modalConfirm = document.getElementById('modalConfirm');
const modalCancel = document.getElementById('modalCancel');

function showConfirmModal(title, message) {
  return new Promise((resolve) => {
    modalTitle.textContent = title;
    modalMessage.textContent = message;
    modal.classList.remove('hidden');
    
    const handleConfirm = () => {
      modal.classList.add('hidden');
      modalConfirm.removeEventListener('click', handleConfirm);
      modalCancel.removeEventListener('click', handleCancel);
      resolve(true);
    };
    
    const handleCancel = () => {
      modal.classList.add('hidden');
      modalConfirm.removeEventListener('click', handleConfirm);
      modalCancel.removeEventListener('click', handleCancel);
      resolve(false);
    };
    
    modalConfirm.addEventListener('click', handleConfirm);
    modalCancel.addEventListener('click', handleCancel);
  });
}

async function loadContactsOnce(){
  body.innerHTML = '<tr class="table-row"><td class="py-12 text-center" colspan="4"><div class="text-gray-500">Loading contacts…</div></td></tr>';
  try{
    const res = await fetch('/api/contacts', { cache: 'no-store' })
    if(!res.ok) throw new Error('Status ' + res.status);
    contactsCache = await res.json();
  }catch(err){
    console.error('[UI] loadContacts error', err);
    body.innerHTML = '<tr class="table-row"><td class="py-12 text-center" colspan="4"><div class="text-red-500">Error loading data (cannot read contacts)</div></td></tr>';
    contactsCache = [];
  }
}

function applySort(list, by='name', dir='asc'){
  const copy = Array.from(list);
  const reverse = (dir === 'desc');
  copy.sort((a,b)=>{
    const va = (a[by] || '').toString().toLowerCase();
    const vb = (b[by] || '').toString().toLowerCase();
    if(va < vb) return reverse ? 1 : -1;
    if(va > vb) return reverse ? -1 : 1;
    return 0;
  });
  return copy;
}

function renderList(list){
  if(!list || list.length === 0){
    body.innerHTML = `
      <tr class="table-row">
        <td class="py-12 text-center" colspan="4">
          <div class="text-gray-500">No contacts found</div>
        </td>
      </tr>`;
    return;
  }

  body.innerHTML = '';

  list.forEach(contact=>{
    const initials = ((contact.name||'').match(/\b\w/g)||[])
                      .slice(0,2).join('').toUpperCase();

    const tr = document.createElement('tr');
    tr.className = 'table-row cursor-pointer hover:bg-blue-50/50';
    tr.dataset.id = contact.id;

    tr.innerHTML = `
<td class="px-6 py-5">
  <div class="flex items-center gap-4">
    <div class="size-10 rounded-full bg-gradient-to-br from-primary/20 to-blue-100 text-primary
                flex items-center justify-center font-semibold text-xs border border-primary/10">
      ${initials}
    </div>
    <div>
      <span class="text-sm font-medium text-gray-900 block">${contact.name}</span>
    </div>
  </div>
</td>

<td class="px-6 py-5 text-sm text-gray-600">
  ${contact.phone}
</td>

<td class="px-6 py-5">
  <span class="text-[11px] font-bold text-gray-400 uppercase tracking-wider px-2 py-1 bg-gray-100 rounded">
    ${contact.group || 'No Group'}
  </span>
</td>

<td class="px-6 py-5 text-right">
  <div class="flex items-center justify-end gap-2">
    <button class="delete-btn p-2 rounded-lg hover:bg-red-100 transition-colors"
            data-id="${contact.id}"
            title="Delete contact">
      <span class="material-symbols-outlined text-xl text-gray-400 hover:text-red-500 transition">delete</span>
    </button>
  </div>
</td>
`;
    body.appendChild(tr);
  });
}


function filterAndRender(keyword=''){
  const kw = (keyword || '').toString().trim().toLowerCase();
  let list = contactsCache;
  
  if(kw){
    // Check for group prefix: "gr:" or "group:"
    const groupMatch = kw.match(/^(gr:|group:)\s*(.*)$/);
    
    if(groupMatch){
      // Search only by group name
      const groupQuery = groupMatch[2].trim();
      if(groupQuery){
        list = list.filter(c => 
          (c.group || '').toString().toLowerCase().includes(groupQuery)
        );
      }
    } else {
      // Normal search: name, phone, or group
      list = list.filter(c => 
        (c.name || '').toString().toLowerCase().includes(kw) ||
        (c.phone || '').toString().toLowerCase().includes(kw) ||
        (c.group || '').toString().toLowerCase().includes(kw)
      );
    }
  }
  
  const by = sortByEl ? sortByEl.value : 'name';
  const dir = sortDirEl ? sortDirEl.value : 'asc';
  list = applySort(list, by, dir);
  renderList(list);
}

// initial load
(async function(){
  await loadContactsOnce();
  filterAndRender();
})();

// search with debounce
input.addEventListener('input', function(){
  clearTimeout(debounceTimer);
  const v = this.value.trim();
  debounceTimer = setTimeout(()=> filterAndRender(v), 200);
});

// sort controls
if(sortByEl) sortByEl.addEventListener('change', ()=> filterAndRender(input.value.trim()));
if(sortDirEl) sortDirEl.addEventListener('change', ()=> filterAndRender(input.value.trim()));

// delete all button
const deleteAllBtn = document.getElementById('deleteAllBtn');
if(deleteAllBtn){
  deleteAllBtn.addEventListener('click', async function(){
    if(contactsCache.length === 0){
      showToast('No contacts to delete', 'error');
      return;
    }

    const confirmed = await showConfirmModal(
      'Delete All Contacts',
      `Are you sure you want to delete ALL ${contactsCache.length} contacts? This action cannot be undone.`
    );
    if(!confirmed) return;

    try{
      // Xóa từng contact một
      const deletePromises = contactsCache.map(contact => 
        fetch('/api/delete', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: contact.id })
        })
      );

      const results = await Promise.all(deletePromises);
      const allSuccess = results.every(r => r.ok);

      if(allSuccess){
        contactsCache = [];
        filterAndRender(input.value.trim());
        showToast('All contacts deleted successfully!', 'success');
      } else {
        showToast('Error occurred while deleting some contacts', 'error');
        // Reload lại để đồng bộ
        await loadContactsOnce();
        filterAndRender(input.value.trim());
      }
    }catch(err){
      console.error(err);
      showToast('Server connection error', 'error');
    }
  });
}

body.addEventListener('click', async function(e){
  // Handle delete button click
  const btn = e.target.closest('.delete-btn');
  if(btn) {
    e.stopPropagation();
    const id = btn.dataset.id;
    if(!id) return;

    const confirmed = await showConfirmModal(
      'Delete Contact',
      'Are you sure you want to delete this contact? This action cannot be undone.'
    );
    if(!confirmed) return;

    try{
      const res = await fetch('/api/delete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id })
      });

      const result = await res.json();

      if(!res.ok || !result.success){
        showToast(result.message || 'Delete failed', 'error');
        return;
      }

      contactsCache = contactsCache.filter(
        c => String(c.id) !== String(id)
      );

      filterAndRender(input.value.trim());
      showToast('Contact deleted successfully!', 'success');

    }catch(err){
      console.error(err);
      showToast('Server connection error', 'error');
    }
    return;
  }
});

function showToast(message, type = 'success') {
  const toast = document.getElementById('toast');
  const toastMessage = document.getElementById('toastMessage');
  toastMessage.textContent = message;
  toast.className = `fixed right-6 bottom-6 px-6 py-4 rounded-xl shadow-2xl flex items-center gap-3 z-50 ${type === 'success' ? 'bg-green-600 text-white' : 'bg-red-600 text-white'}`;
  toast.classList.remove('hidden');
  setTimeout(() => toast.classList.add('hidden'), 3000);
}

// Logout function
async function handleLogout() {
  const confirmed = await showConfirm('Logout', 'Are you sure you want to logout?', true);
  if (confirmed) {
    fetch('/api/logout', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      }
    })
    .then(response => response.json())
    .then(data => {
      window.location.href = '/login';
    })
    .catch(error => {
      console.error('Error:', error);
      window.location.href = '/login';
    });
  }
}
</script>
</body></html>