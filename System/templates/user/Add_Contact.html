<!doctype html>
<html class="light" lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Thêm Liên Hệ | ContactHub</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
  <script id="tailwind-config">
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            "primary": "#136dec",
            "background": "#f5f7fa",
            "sidebar": "#f8f9fa",
            "border-color": "#e5e7eb"
          },
          fontFamily: {
            "sans": ["Inter", "sans-serif"]
          }
        },
      },
    }
  </script>
  <style>
    .material-symbols-outlined {
      font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
    }
    .input-field:focus {
      box-shadow: 0 0 0 3px rgba(19, 109, 236, 0.15);
    }
    .toast-animation {
      animation: slideIn 0.3s ease-out;
    }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
  </style>
</head>
<body class="min-h-screen bg-background font-sans antialiased">
  <!-- Top Navigation Bar -->
  <nav class="bg-white border-b border-border-color shadow-sm sticky top-0 z-50">
    <div class="max-w-5xl mx-auto px-4 sm:px-6">
      <div class="flex items-center justify-between h-16">
        <a href="/dashboard" class="flex items-center gap-2 text-primary hover:text-blue-700 transition-colors">
          <span class="material-symbols-outlined">arrow_back</span>
          <span class="font-medium hidden sm:inline">Quay lại Danh bạ</span>
        </a>
        <h1 class="text-lg font-semibold text-gray-800">Thêm Liên Hệ Mới</h1>
        <div class="w-10"></div> <!-- Spacer for centering -->
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="max-w-2xl mx-auto px-4 py-8">
    <div class="bg-white rounded-2xl shadow-lg border border-border-color overflow-hidden">
      <!-- Form Header with Avatar Upload -->
      <div class="bg-gradient-to-r from-primary to-blue-600 px-8 py-10 text-center">
        <div class="inline-flex items-center justify-center w-24 h-24 bg-white/20 backdrop-blur-sm rounded-full mb-4 border-4 border-white/30">
          <span class="material-symbols-outlined text-white" style="font-size: 48px;">person_add</span>
        </div>
        <h2 class="text-xl font-semibold text-white">Thêm Liên Hệ Mới</h2>
        <p class="text-blue-100 text-sm mt-1">Điền thông tin liên hệ bên dưới</p>
      </div>

      <!-- Form Body -->
      <form id="addContactForm" class="p-8 space-y-6" novalidate>
        <!-- Name Field -->
        <div class="space-y-2">
          <label class="flex items-center gap-2 text-sm font-semibold text-gray-700">
            <span class="material-symbols-outlined text-primary" style="font-size: 18px;">badge</span>
            Họ và Tên <span class="text-red-500">*</span>
          </label>
          <input 
            name="name" 
            required 
            class="input-field w-full border border-gray-300 rounded-xl px-4 py-3.5 focus:border-primary focus:outline-none transition-all" 
            placeholder="Nguyễn Văn A" 
          />
        </div>

        <!-- Phone Field -->
        <div class="space-y-2">
          <label class="flex items-center gap-2 text-sm font-semibold text-gray-700">
            <span class="material-symbols-outlined text-primary" style="font-size: 18px;">call</span>
            Số Điện Thoại <span class="text-red-500">*</span>
          </label>
          <input 
            name="phone" 
            required 
            type="tel"
            class="input-field w-full border border-gray-300 rounded-xl px-4 py-3.5 focus:border-primary focus:outline-none transition-all" 
            placeholder="0901 234 567" 
          />
        </div>

        <!-- Group Field -->
        <div class="space-y-2">
          <label class="flex items-center gap-2 text-sm font-semibold text-gray-700">
            <span class="material-symbols-outlined text-primary" style="font-size: 18px;">group</span>
            Nhóm
          </label>
          <div class="flex gap-2">
            <select 
              name="group" 
              id="groupSelect"
              class="input-field flex-1 border border-gray-300 rounded-xl px-4 py-3.5 focus:border-primary focus:outline-none transition-all bg-white"
            >
              <option value="">-- Chưa có nhóm nào --</option>
            </select>
            <a href="/add-group" class="flex items-center justify-center px-4 py-3.5 bg-gray-100 hover:bg-gray-200 border border-gray-300 rounded-xl transition-colors" title="Tạo nhóm mới">
              <span class="material-symbols-outlined text-gray-600" style="font-size: 20px;">add</span>
            </a>
          </div>
          <p id="noGroupsHint" class="text-sm text-gray-500 hidden">Chưa có nhóm nào. <a href="/add-group" class="text-primary hover:underline">Tạo nhóm mới</a></p>
        </div>

        <!-- Notes Field -->
        <div class="space-y-2">
          <label class="flex items-center gap-2 text-sm font-semibold text-gray-700">
            <span class="material-symbols-outlined text-primary" style="font-size: 18px;">notes</span>
            Ghi Chú
          </label>
          <textarea 
            name="notes" 
            rows="3"
            class="input-field w-full border border-gray-300 rounded-xl px-4 py-3.5 focus:border-primary focus:outline-none transition-all resize-none" 
            placeholder="Thêm ghi chú về liên hệ này..."
          ></textarea>
        </div>

        <!-- Action Buttons -->
        <div class="flex flex-col sm:flex-row justify-end gap-3 pt-6 border-t border-gray-100">
          <a 
            href="/dashboard" 
            class="px-6 py-3 border border-gray-300 rounded-xl text-gray-700 hover:bg-gray-50 transition-colors font-medium text-center order-2 sm:order-1"
          >
            Hủy bỏ
          </a>
          <button 
            type="submit" 
            id="submitBtn"
            class="px-8 py-3 bg-primary text-white rounded-xl hover:bg-blue-700 transition-all shadow-md hover:shadow-lg font-semibold flex items-center justify-center gap-2 order-1 sm:order-2"
          >
            <span class="material-symbols-outlined" style="font-size: 20px;">save</span>
            Lưu Liên Hệ
          </button>
        </div>
      </form>
    </div>

    <!-- Quick Tips -->
    <div class="mt-6 bg-blue-50 rounded-xl p-4 border border-blue-100">
      <div class="flex items-start gap-3">
        <span class="material-symbols-outlined text-primary mt-0.5">lightbulb</span>
        <div>
          <h3 class="font-medium text-gray-800 text-sm">Mẹo nhỏ</h3>
          <p class="text-gray-600 text-sm mt-1">Các trường có dấu <span class="text-red-500">*</span> là bắt buộc. Thêm email để dễ dàng liên lạc qua nhiều kênh.</p>
        </div>
      </div>
    </div>
  </main>

  <!-- Toast Notifications -->
  <div id="toast" class="hidden fixed right-6 bottom-6 bg-green-600 text-white px-6 py-4 rounded-xl shadow-2xl flex items-center gap-3 toast-animation z-50">
    <span class="material-symbols-outlined">check_circle</span>
    <span id="toastMessage">Đã lưu liên hệ thành công!</span>
  </div>
  <div id="errorToast" class="hidden fixed right-6 bottom-6 bg-red-600 text-white px-6 py-4 rounded-xl shadow-2xl flex items-center gap-3 toast-animation z-50">
    <span class="material-symbols-outlined">error</span>
    <span id="errorToastMessage">Có lỗi xảy ra</span>
  </div>

<script>
// Load groups from API - chỉ hiển thị groups đã tạo
async function loadGroups() {
  const select = document.getElementById('groupSelect');
  const noGroupsHint = document.getElementById('noGroupsHint');
  
  try {
    const response = await fetch('/api/groups');
    const result = await response.json();
    
    if (result.success && result.groups && result.groups.length > 0) {
      // Clear and add options
      select.innerHTML = '<option value="">-- Chọn nhóm --</option>';
      result.groups.forEach(group => {
        const option = document.createElement('option');
        option.value = group.name || group.id;
        option.textContent = group.name;
        if (group.color) {
          option.style.color = group.color;
        }
        select.appendChild(option);
      });
      noGroupsHint.classList.add('hidden');
    } else {
      // No groups created yet
      select.innerHTML = '<option value="">-- Chưa có nhóm nào --</option>';
      noGroupsHint.classList.remove('hidden');
    }
  } catch (error) {
    console.log('Error loading groups:', error);
    select.innerHTML = '<option value="">-- Lỗi tải nhóm --</option>';
  }
}

// Add contact form handler
document.getElementById('addContactForm').addEventListener('submit', async function(e){
  e.preventDefault();
  
  const submitBtn = document.getElementById('submitBtn');
  const originalText = submitBtn.innerHTML;
  
  // Get form values
  const name = this.name.value.trim();
  const phone = this.phone.value.trim();
  const group = this.group.value;
  const notes = this.notes.value.trim();
  
  // Validation
  if(!name) {
    showToast('errorToast', 'Vui lòng nhập họ và tên.');
    this.name.focus();
    return;
  }
  
  if(!phone) {
    showToast('errorToast', 'Vui lòng nhập số điện thoại.');
    this.phone.focus();
    return;
  }
  
  // Basic phone validation
  const phoneDigits = phone.replace(/\D/g, '');
  if(phoneDigits.length < 8) {
    showToast('errorToast', 'Số điện thoại không hợp lệ (ít nhất 8 số).');
    this.phone.focus();
    return;
  }
  
  // Show loading state
  submitBtn.disabled = true;
  submitBtn.innerHTML = '<span class="material-symbols-outlined animate-spin" style="font-size: 20px;">sync</span> Đang lưu...';
  
  const contactData = {
    name: name,
    phone: phone,
    group: group || '',
    notes: notes || ''
  };
  
  try {
    const response = await fetch('/api/contact', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(contactData)
    });
    
    const result = await response.json();
    
    if (response.ok && result.success) {
      showToast('toast', 'Đã lưu liên hệ thành công!');
      this.reset();
      // Redirect to dashboard after 1.5 seconds
      setTimeout(() => {
        window.location.href = '/dashboard';
      }, 1500);
    } else {
      showToast('errorToast', result.message || 'Lỗi khi lưu liên hệ');
      submitBtn.disabled = false;
      submitBtn.innerHTML = originalText;
    }
  } catch (error) {
    console.error('Error:', error);
    showToast('errorToast', 'Không thể kết nối đến server');
    submitBtn.disabled = false;
    submitBtn.innerHTML = originalText;
  }
});

function showToast(toastId, message) {
  // Hide all toasts first
  document.getElementById('toast').classList.add('hidden');
  document.getElementById('errorToast').classList.add('hidden');
  
  const toast = document.getElementById(toastId);
  const messageEl = document.getElementById(toastId === 'toast' ? 'toastMessage' : 'errorToastMessage');
  messageEl.textContent = message;
  toast.classList.remove('hidden');
  
  setTimeout(() => toast.classList.add('hidden'), 4000);
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
  loadGroups();
  // Focus on name field
  document.querySelector('input[name="name"]').focus();
});
</script>
</body>
</html>